services:
  app:
    build:
      context: .
      dockerfile: Dockerfile.prod
    restart: always
    ports:
      - "8011:8000"
    volumes:
      # Mount full systemd runtime directory for proper D-Bus communication
      - /run/systemd:/run/systemd:ro
      # Mount D-Bus system socket for systemd communication
      - /var/run/dbus/system_bus_socket:/var/run/dbus/system_bus_socket:ro
      # Mount cgroup for systemd access
      - /sys/fs/cgroup:/sys/fs/cgroup:ro
      # Mount systemd journal files (CRITICAL for reading logs)
      - /var/log/journal:/var/log/journal:ro
      - /run/log/journal:/run/log/journal:ro
      # Mount machine-id for journal reader
      - /etc/machine-id:/etc/machine-id:ro
    env_file:
      - .env
    environment:
      # Ensure D-Bus uses the correct socket
      - DBUS_SYSTEM_BUS_ADDRESS=unix:path=/var/run/dbus/system_bus_socket
    # Required for systemd access
    privileged: true
    pid: "host"
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"